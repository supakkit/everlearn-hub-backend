services:
  db:
    image: postgres:latest
    restart: always
    environment:
      POSTGRES_DB: ${POSTGRES_DB}
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
    ports:
      - "${DATABASE_PORT}:5432"
    volumes:
      - postgres_data:/var/lib/postgresql

  redis:
    image: redis:7
    container_name: redis_local
    restart: always
    ports:
      - "${REDIS_PORT}:6379"
    command: ["redis-server", "--appendonly", "yes"]
    volumes:
      - redis_data:/data

  stripe:
    image: stripe/stripe-cli:latest
    container_name: stripe_cli
    restart: unless-stopped
    environment:
      STRIPE_API_KEY: ${STRIPE_SECRET_KEY}
      STRIPE_DEVICE_NAME: docker
    # Forward Stripe events â†’ your NestJS service
    command: [
      "listen",
      "--forward-to",
      "http://host.docker.internal:${PORT}/${GLOBAL_PREFIX}/stripe/webhook"
    ]
    # allow network access to host machine for webhooks
    extra_hosts:
      - "host.docker.internal:host-gateway"

volumes:
  postgres_data:
    driver: local
  redis_data:
    driver: local
